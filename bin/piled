# -*- python -*-

import asyncio
import aiohttp

from urllib.parse import unquote
from pile import Pile
from pathlib import Path
import json

from aiohttp import web

app = web.Application()
path = Path("~/Documents").expanduser()

async def handle_docs(request):
    return web.FileResponse("./static/docs.html")

async def handle_dfile(request):
    name = unquote(request.match_info.get('name', ""))
    return web.FileResponse(path.joinpath(name))

async def handle_app_list(request):
    pile = Pile.from_folder(path)
    return web.json_response(pile.list())

app.router.add_get("/", handle_docs)
app.router.add_get("/dfile/{name}", handle_dfile)

app.router.add_get("/app/list", handle_app_list)

app.router.add_static("/static", "./static", show_index=True)
app.router.add_static("/js", "./js", show_index=True)

if __name__ == '__main__':
    web.run_app(app)
